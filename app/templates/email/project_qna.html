<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ project.name }} – Project Q&A</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* Base */
    body { margin:0; padding:0; background:#f6f8fb; color:#111827; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    a { color:#0ea5e9; }
    .preheader { display:none!important; visibility:hidden; opacity:0; color:transparent; height:0; width:0; overflow:hidden; mso-hide:all; }

    /* Layout */
    .wrap { padding:24px 0; }
    .container { width:100%; max-width:720px; margin:0 auto; background:#ffffff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.06); overflow:hidden; }
    .header { padding:20px 24px; background:#0ea5e9; color:#ffffff; }
    .header h1 { margin:0 0 4px 0; font-size:20px; line-height:1.3; }
    .header a { color:#ffffff; text-decoration:underline; }
    .content { padding:24px; }
    .footer { padding:16px 24px; color:#6b7280; font-size:12px; background:#f9fafb; }

    /* Components */
    .meta { color:#6b7280; font-size:13px; margin:6px 0 0 0; }
    .btn { display:inline-block; background:#0ea5e9; color:#ffffff!important; text-decoration:none; padding:10px 14px; border-radius:8px; }
    .summary { background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:12px 14px; margin:16px 0; font-size:14px; }
    .summary strong { color:#111827; }

    .qa { border-top:1px solid #e5e7eb; padding-top:16px; margin-top:16px; }
    .q { font-weight:600; margin:0 0 8px 0; }
    .a { margin:0 0 8px 0; line-height:1.5; }
    .badge { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#fef3c7; color:#92400e; vertical-align:middle; }
    .badge.inferred { background:#e0e7ff; color:#3730a3; }
    .badge.warn { background:#fee2e2; color:#991b1b; }

    .conf-row { display:flex; align-items:center; gap:8px; font-size:13px; color:#374151; }
    .bar { flex:1; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }

    /* Evidence box */
    .evidence-box { background:#f8fafc; border:1px dashed #d1d5db; border-radius:8px; padding:10px 12px; margin-top:10px; }
    .evidence-label { font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.03em; margin:0 0 6px 0; }
    .evidence-list { color:#374151; font-size:13px; margin:0; padding-left:18px; }
    .evidence-list li { margin:2px 0; }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      body { background:#0b1220; color:#e5e7eb; }
      .container { background:#0f172a; box-shadow:none; }
      .header { background:#0284c7; }
      .footer { background:#0b1220; color:#94a3b8; }
      .summary { background:#0b1220; border-color:#1f2937; }
      .qa { border-color:#1f2937; }
      .meta { color:#94a3b8; }
      .bar { background:#1f2937; }
      .evidence-box { background:#0b1220; border-color:#1f2937; }
      .evidence-label { color:#94a3b8; }
      .evidence-list { color:#cbd5e1; }
    }
  </style>
</head>
<body>
  <!-- Inbox preview line -->
  <span class="preheader">Q&A for {{ project.name }} — {{ pairs|length }} questions</span>

  <div class="wrap">
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>Project Q&amp;A · {{ project.name }}</h1>
        <div><a href="{{ project.repo_url }}">{{ project.repo_url }}</a></div>
      </div>

      <!-- Body -->
      <div class="content">
        <div class="meta">
          Generated {{ meta.generated_at_iso }}{% if meta.model %} · Model: {{ meta.model }}{% endif %}{% if meta.prompt_version %} · Prompt v{{ meta.prompt_version }}{% endif %}
        </div>

        {% set total = pairs|length %}
        {% set insuff = pairs|selectattr('insufficient_evidence')|list|length %}
        {% set avg = (pairs|map(attribute='confidence')|sum) / (total if total>0 else 1) %}
        <div class="summary">
          <div><strong>Summary</strong></div>
          <div>Questions: {{ total }} · Avg confidence: {{ (avg*100)|round(0) }}% · With insufficient evidence: {{ insuff }}</div>
          <div style="margin-top:10px;">
            <a class="btn" href="{{ project.repo_url }}">Open Repository</a>
          </div>
        </div>

        {# Q&A blocks #}
        {% for p in pairs %}
          {% set conf_pct = (p.confidence * 100)|round(0) %}
          {% set color = '#10b981' if p.confidence >= 0.75 else ('#f59e0b' if p.confidence >= 0.5 else '#ef4444') %}
          {% set inferred = (p.answer.startswith('Inferred:')) %}
          <div class="qa">
            <p class="q">
              {{ loop.index }}. {{ p.question }}
              {% if p.insufficient_evidence %}<span class="badge warn">Insufficient evidence</span>{% endif %}
              {% if inferred %}<span class="badge inferred">Inferred</span>{% endif %}
            </p>

            <p class="a">
              {% if inferred %}<strong>Inferred:</strong> {{ p.answer[9:]|trim }}{% else %}{{ p.answer }}{% endif %}
            </p>

            <div class="conf-row">
              <div style="min-width:90px;">Confidence {{ conf_pct }}%</div>
              <div class="bar">
                <div style="height:8px; width: {{ conf_pct }}%; background: {{ color }};"></div>
              </div>
            </div>

            {% if p.evidence_snippets %}
              <div class="evidence-box">
                <div class="evidence-label">Evidence from analysis</div>
                <ul class="evidence-list">
                  {% for s in p.evidence_snippets %}
                    <li>“{{ s }}”</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Footer -->
      <div class="footer">
        Sent by DevDox · This summary may include model-generated inferences.
      </div>
    </div>
  </div>
</body>
</html>
